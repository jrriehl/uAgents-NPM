var he=Object.defineProperty,fe=Object.defineProperties;var ye=Object.getOwnPropertyDescriptors;var qt=Object.getOwnPropertySymbols;var _e=Object.prototype.hasOwnProperty,ve=Object.prototype.propertyIsEnumerable;var Ht=Math.pow,Vt=(r,t,e)=>t in r?he(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e,M=(r,t)=>{for(var e in t||(t={}))_e.call(t,e)&&Vt(r,e,t[e]);if(qt)for(var e of qt(t))ve.call(t,e)&&Vt(r,e,t[e]);return r},N=(r,t)=>fe(r,ye(t));var g=(r,t,e)=>new Promise((s,n)=>{var i=c=>{try{a(e.next(c))}catch(d){n(d)}},o=c=>{try{a(e.throw(c))}catch(d){n(d)}},a=c=>c.done?s(c.value):Promise.resolve(c.value).then(i,o);a((e=e.apply(r,t)).next())});export*from"util";var is="tmp";var os="tmp";import{v4 as $e}from"uuid";var Wt="agent",gs="fetch",j="user",jt="test-agent",G="agent",Gt=65,Jt="fetch1mezzhfj7qgveewzwzdk6lz5sae4dunpmmsjr9u7z0tpmdsae8zmquq3y0y",Kt="fetch1tjagw8g8nn4cwuw00cf0m5tl4l6wfw9c0ue507fhx9e3yrsck8zs0l3q4w",dt="fetch1479lwv5vy8skute5cycuz727e55spkhxut0valrcm38x9caa2x8q99ef0q",ut="fetch1mxz8kn3l5ksaftx8a9pj9a6prpzk2uhxnqdkwuqvuh37tw80xu6qges77l",D="500000000000000000",pt="atestfet",zt=3600,ls=60,mt=6,ht="2.3.0",Xt="https://agentverse.ai",T=`${Xt}/v1/almanac`,ds=1,J=10,K=100,us=1,ps=2,ms=5,b=30,L=10,ft=100,z="https://rpc-dorado.fetch.ai",X="https://rpc-fetchhub.fetch.ai",Zt="https://faucet-dorado.fetch.ai";function hs(r){let t=[];return typeof r=="object"&&!Array.isArray(r)&&r!==null?t=Object.entries(r).map(([e,s])=>({url:e,weight:(s==null?void 0:s.weight)||1})):Array.isArray(r)?t=r.map(e=>({url:e,weight:1})):typeof r=="string"&&(t=[{url:r,weight:1}]),t}function fs(r=null){let t=null,e=Xt,s=null,n=null;return typeof r=="string"?r.includes("@")?[t,e]=r.split("@"):r.includes("://")?e=r:t=r:typeof r=="object"&&r!==null&&(t=r.agent_mailbox_key||null,e=r.base_url||e,n=r.protocol||null),[s,e]=e.includes("://")?e.split("://"):[null,e],s=n||s||"https",{agentMailboxKey:t,baseUrl:e,protocol:s,httpPrefix:s==="wss"||s==="https"?"https":"http",useMailbox:t!==null}}import{randomBytes as Ee}from"crypto";import{ec as Ae}from"elliptic";import{bech32 as Y}from"bech32";import{sha256 as tt}from"js-sha256";var Yt=2e3,we=256,$=new Ae("secp256k1");function Qt(r){let t=Y.decode(r,Yt),e=Buffer.from(Y.fromWords(t.words));return[t.prefix,e]}function Q(r,t){let e=Y.toWords(t);return Y.encode(r,e,Yt)}function bs(){return Q(j,Ee(32))}function F(r){return r.substring(0,j.length)===j}function be(r,t){let e=tt.create();if(e.update(r),!(0<=t&&t<we))throw new Error("Index out of bounds");return e.update(Buffer.from([t])),Buffer.from(e.digest())}function Se(r){let t=tt.create();return t.update(r),Buffer.from(t.digest())}function xe(r,t,e){let s=tt.create();return s.update(be(t,e)),s.update(Se(r)),Buffer.from(s.digest())}function Z(r){let t;if(typeof r=="string")t=Buffer.from(r);else if(typeof r=="number")t=Buffer.alloc(8),t.writeBigUInt64BE(BigInt(r));else if(Buffer.isBuffer(r))t=r;else throw new Error("Invalid type for encoding");let e=Buffer.alloc(8);return e.writeBigUInt64BE(BigInt(t.length)),Buffer.concat([e,t])}var A=class r{constructor(t){this.keyPair=t;let e=Buffer.from(this.keyPair.getPublic().encode("hex",!0),"hex");this.address=Q("agent",e),this.pubKey=e.toString("hex")}static fromSeed(t,e){let s=xe(t,"agent",e),n=$.keyFromPrivate(s);return new r(n)}static generate(){let t=$.genKeyPair();return new r(t)}static fromString(t){let e=$.keyFromPrivate(t,"hex");return new r(e)}get privateKey(){return this.keyPair.getPrivate("hex")}get getAddress(){return this.address}get getPubKey(){return this.pubKey}sign(t){let e=this.keyPair.sign(t),s=this.getCanonicalSignature(e);return Q("sig",s)}signB64(t){let e=this.keyPair.sign(t);return this.getCanonicalSignature(e).toString("base64")}signDigest(t){let e=this.keyPair.sign(t),s=this.getCanonicalSignature(e);return Q("sig",s)}signRegistration(t,e,s){let n=tt.create();return n.update(Z(t)),n.update(Z(this.address)),n.update(Z(e)),n.update(Z(s)),this.signDigest(Buffer.from(n.digest()))}signArbitrary(t){let e={chain_id:"",account_number:"0",sequence:"0",fee:{gas:"0",amount:[]},msgs:[{type:"sign/MsgSignData",value:{signer:this.address,data:t.toString("base64")}}],memo:""},s=Buffer.from(JSON.stringify(e,Object.keys(e).sort(),0)),n=this.signB64(s);return[s.toString("base64"),n]}static verifyDigest(t,e,s){let[n,i]=Qt(t),[o,a]=Qt(s);if(n!=="agent")throw new Error("Unable to decode agent address");if(o!=="sig")throw new Error("Unable to decode signature");if(a.length!==64)throw new Error("Invalid signature length");let c=a.subarray(0,32),d=a.subarray(32);if(!$.keyFromPublic(i).verify(e,{r:c,s:d}))throw new Error("Unable to verify signature")}getCanonicalSignature(t){let e=t.r,s=t.s,n=$.curve.n,i=n.shrn(1),o=s;s.gt(i)&&(o=n.sub(s));let a=Buffer.from(e.toArray("be",32)),c=Buffer.from(o.toArray("be",32));return Buffer.concat([a,c])}};var yt=class{constructor(){this._sinks=new Map}get sinks(){return this._sinks}register(t,e){var n;let s=(n=this._sinks.get(t))!=null?n:new Set;s.add(e),this._sinks.set(t,s)}unregister(t,e){let s=this._sinks.get(t);if(s){if(s.delete(e),s.size===0){this._sinks.delete(t);return}this._sinks.set(t,s)}}contains(t){return this._sinks.has(t)}dispatchMsg(t,e,s,n,i){return g(this,null,function*(){let o=this._sinks.get(e)||new Set;for(let a of o)yield a.handleMessage(t,s,n,i)})}dispatchRest(t,e,s,n){return g(this,null,function*(){let i=this._sinks.get(t)||new Set;for(let o of i)return yield o.handleRest(e,s,n)})}},O=new yt;import{sha256 as Re}from"js-sha256";import{z as w}from"zod";var S=class r{constructor({version:t,sender:e,target:s,session:n,schemaDigest:i,protocolDigest:o,payload:a,expires:c,nonce:d,signature:p}){this.version=t,this.sender=e,this.target=s,this.session=n,this.schemaDigest=i,this.protocolDigest=o,this.payload=a,this.expires=c,this.nonce=d,this.signature=p}encodePayload(t){this.payload=Buffer.from(t).toString("base64")}decodePayload(){return this.payload?Buffer.from(this.payload,"base64").toString():""}sign(t){try{this.signature=t.signDigest(this._digest())}catch(e){throw new Error(`Failed to sign envelope: ${e}`)}}verify(){if(!this.signature)throw new Error("Envelope signature is missing");console.log("Digest",this._digest().toString("hex")),A.verifyDigest(this.sender,this._digest(),this.signature)}toJSON(){var e,s,n,i,o,a;let t={version:this.version,sender:this.sender,target:this.target,session:this.session,schema_digest:(e=this.schemaDigest)!=null?e:null,protocol_digest:(s=this.protocolDigest)!=null?s:null,payload:(n=this.payload)!=null?n:null,expires:(i=this.expires)!=null?i:null,nonce:(o=this.nonce)!=null?o:null,signature:(a=this.signature)!=null?a:null};return JSON.stringify(t)}_digest(){let t=Re.create();if(t.update(this.sender),t.update(this.target),t.update(this.session),t.update(this.schemaDigest),this.payload&&t.update(this.payload),this.expires){let e=Buffer.alloc(8);e.writeBigUInt64BE(BigInt(this.expires)),t.update(e)}if(this.nonce!==void 0){let e=Buffer.alloc(8);e.writeBigUInt64BE(BigInt(this.nonce)),t.update(e)}return Buffer.from(t.digest())}static modelValidate(t){var n,i,o,a,c;let s=w.object({version:w.number(),sender:w.string(),target:w.string(),session:w.string(),schema_digest:w.string(),protocol_digest:w.string().nullish(),payload:w.string().nullish(),expires:w.number().nullish(),nonce:w.number().nullish(),signature:w.string().nullish()}).parse(t);return new r({version:s.version,sender:s.sender,target:s.target,session:s.session,schemaDigest:s.schema_digest,protocolDigest:(n=s.protocol_digest)!=null?n:void 0,payload:(i=s.payload)!=null?i:void 0,expires:(o=s.expires)!=null?o:void 0,nonce:(a=s.nonce)!=null?a:void 0,signature:(c=s.signature)!=null?c:void 0})}},te=class r{constructor({timestamp:t=Math.floor(Date.now()/1e3),version:e,sender:s,target:n,session:i,schemaDigest:o,protocolDigest:a,payload:c}){this.timestamp=t,this.version=e,this.sender=s,this.target=n,this.session=i,this.schemaDigest=o,this.protocolDigest=a,this.payload=c}static fromEnvelope(t){return new r({version:t.version,sender:t.sender,target:t.target,session:t.session,schemaDigest:t.schemaDigest,protocolDigest:t.protocolDigest,payload:t.decodePayload()})}},ee=class{constructor(){this.envelopes=[]}addEntry(t){this.envelopes.push(t),this.applyRetentionPolicy()}applyRetentionPolicy(){let t=Math.floor(Date.now()/1e3)-86400;this.envelopes=this.envelopes.filter(e=>e.timestamp>=t)}};import{z as se}from"zod";import Me from"crypto";import{extendZodWithOpenApi as Pe,createSchema as Ce}from"zod-openapi";Pe(se);var f=class r{constructor(t){if(!t||!(t instanceof se.ZodType))throw new Error("Invalid input. Provide a Zod schema.");this.schema=t}validate(t){return this.schema.parse(t)}dumpJson(t){return JSON.stringify(t,null,0)}dump(t){return this.schema.parse(t)}static buildSchemaDigest(t){t instanceof r&&(t=t.schema);let e,{components:s,schema:n}=Ce(t,{componentRefPath:"#/definitions/"});console.log(n,s);let i=s?M({definitions:M({},s)},n):n,o=U(i);return console.log(o),`model:${Me.createHash("sha256").update(o,"utf8").digest("hex")}`}};function U(r){return r===null||typeof r!="object"&&!Array.isArray(r)||Object.keys(r).length===0?JSON.stringify(r):Array.isArray(r)?"["+r.map(U).join(", ")+"]":"{"+Object.keys(r).sort().map(s=>{var i,o;let n=r[s];if(s==="title"&&n==="Properties"||s==="type"&&r.enum&&((i=r.description)!=null&&i.includes("enumeration")))return"";if(s==="$ref")return`"${s}": "${n}"`;if(s==="type"&&n&&typeof n=="object"){if("allOf"in n){let a=(o=n.allOf)==null?void 0:o.find(c=>c.$ref);if(a)return`"${s}": ${U({$ref:a.$ref})}`}else if("$ref"in n)return`"${s}": ${U({$ref:n.$ref})}`}if(s==="required"&&Array.isArray(n)&&r.title==="UAgentResponse")return'"required": ["type"]';if(typeof n=="object"&&n!==null){let a=Object.keys(n);a.includes("type")&&!a.includes("title")&&s!=="Properties"&&(n.title=s.split("_").map(c=>c.charAt(0).toUpperCase()+c.slice(1)).join(" "))}return`"${s}": ${U(n)}`}).filter(Boolean).join(", ")+"}"}import{CosmWasmClient as re,SigningCosmWasmClient as ne}from"@cosmjs/cosmwasm-stargate";var vt=0,_t;function P(r,t){return t.length>vt&&(vt=t.length),{logLevel:r,name:t}}function l(r,t){t||(_t||(_t=P("INFO","default")),t=_t);let e=`${t.logLevel}	 [${t.name.padStart(vt)}]: ${r}`;switch(t.logLevel){case"DEBUG":console.debug(e);break;case"INFO":console.info(e);break;case"WARN":console.warn(e);break;case"ERROR":console.error(e);break}}var y=P("INFO","network"),Te=1,Ie=30,Et,At,wt=null,q=class extends Error{constructor(t="Insufficient funds for transaction"){super(t),this.name="InsufficientFundsError"}};function rt(r=!0){return g(this,null,function*(){return r?(Et||(Et=yield re.connect(z)),Et):(At||(At=yield re.connect(X)),At)})}function Rt(r){return g(this,null,function*(){wt||(wt=new xt(Zt)),yield wt.getWealth(r)})}function Ne(r){return r?typeof r=="object"&&!Array.isArray(r)?Object.entries(r).map(([t,e])=>({address:t,weight:e.weight||1})):Array.isArray(r)?r.map(t=>({address:t,weight:1})):[{address:r,weight:1}]:null}function nt(n,i){return g(this,arguments,function*(r,t,e=Ie*1e3,s=Te*1e3){let o=Date.now();for(;;){try{let a=yield t.getTx(r);if(a)return a}catch(a){}if(Date.now()-o>e)throw new Error("Transaction query timeout");yield new Promise(a=>setTimeout(a,s))}})}var it=class{constructor(t,e){this.client=t,this.address=e}checkVersion(){return g(this,null,function*(){try{let t=yield this.getContractVersion(),[e]=t.split("."),[s]=ht.split(".");return e!==s?(l(`The deployed version of the Almanac Contract is ${t} and you are using version ${ht}. Update uAgents to the latest version to ensure compatibility.`,y),!1):!0}catch(t){return l("Failed to query contract version. Contract interactions will be disabled.",y),!1}})}queryContract(t){return g(this,null,function*(){try{let e=yield this.client.queryContractSmart(this.address,t);if(typeof e!="object")throw new Error("Invalid response format");return e}catch(e){throw l(`Query failed: ${e}`,y),e}})}getContractVersion(){return g(this,null,function*(){let t={query_contract_state:{}};return(yield this.queryContract(t)).contract_version})}getAddress(){return this.address}isRegistered(t){return g(this,null,function*(){let e={query_records:{agent_address:t}};return!!(yield this.queryContract(e)).record})}registrationNeedsUpdate(t,e,s,n){return g(this,null,function*(){let[i,o,a]=yield this.queryAgentRecord(t);return!(yield this.isRegistered(t))||i<n||JSON.stringify(e)!==JSON.stringify(o)||JSON.stringify(s)!==JSON.stringify(a)})}queryAgentRecord(t){return g(this,null,function*(){var d,p;let e={query_records:{agent_address:t}},s=yield this.queryContract(e);if(!s.record){let u=yield this.queryContract({query_contract_state:{}});return[(((d=u==null?void 0:u.state)==null?void 0:d.expiry_height)||0)*mt,[],[]]}let n=((p=s.record[0])==null?void 0:p.expiry)||0,i=s.height||0,o=(n-i)*mt,a=s.record[0].record.service.endpoints.map(u=>({url:u.url,weight:u.weight})),c=s.record[0].record.service.protocols;return[o,a,c]})}getExpiry(t){return g(this,null,function*(){let[e]=yield this.queryAgentRecord(t);return e})}getEndpoints(t){return g(this,null,function*(){let[,e]=yield this.queryAgentRecord(t);return e})}getProtocols(t){return g(this,null,function*(){let[,,e]=yield this.queryAgentRecord(t);return e})}getRegistrationMsg(t,e,s,n,i){return{register:{record:{service:{protocols:t,endpoints:e.map(o=>({url:o.url,weight:o.weight}))}},signature:s,sequence:n,agent_address:i}}}register(t,e,s,n,i,o,a){return g(this,null,function*(){if(!this.address)throw new Error("Contract address not set");let[c]=yield e.getAccounts();if(!c)throw new Error("No account found in wallet");let d=this.getRegistrationMsg(n,i,o,a,s),p=[{denom:pt,amount:D}],u=yield t.execute(c.address,this.address,d,"auto","",p);yield nt(u.transactionHash,this.client)})}registerBatch(t,e,s){return g(this,null,function*(){if(!this.address)throw new Error("Contract address not set");let[n]=yield e.getAccounts();if(!n)throw new Error("No account found in wallet");let i=s.map(a=>{if(a.timestamp===void 0)throw new Error("Agent record is missing timestamp");if(a.signature===void 0)throw new Error("Agent record is not signed");return{typeUrl:"/cosmwasm.wasm.v1.MsgExecuteContract",value:{sender:n.address,contract:this.address,msg:this.getRegistrationMsg(a.protocols,a.endpoints,a.signature,a.timestamp,a.agent_address),funds:[{denom:pt,amount:D}]}}}),o=yield t.signAndBroadcast(n.address,i,"auto");yield nt(o.transactionHash,this.client)})}getSequence(t){return g(this,null,function*(){let e={query_sequence:{agent_address:t}};return(yield this.queryContract(e)).sequence})}},et=null,st=null;function Mt(r=!0){return g(this,null,function*(){if(r){if(!st){let t=yield rt(!0);st=new it(t,Kt)}return(yield st.checkVersion())?st:null}if(!et){let t=yield rt(!1);et=new it(t,Jt)}return(yield et.checkVersion())?et:null})}var at=class{constructor(t,e){this.client=t,this.address=e}queryContract(t){return g(this,null,function*(){try{let e=yield this.client.queryContractSmart(this.address,t);if(typeof e!="object")throw new Error("Invalid response format");return e}catch(e){throw l(`Query failed: ${e}`,y),e}})}isNameAvailable(t,e){return g(this,null,function*(){let s={domain_record:{domain:`${t}.${e}`}};return(yield this.queryContract(s)).is_available})}isOwner(t,e,s){return g(this,null,function*(){let n={permissions:{domain:`${t}.${e}`,owner:s}};return(yield this.queryContract(n)).permissions==="admin"})}isDomainPublic(t){return g(this,null,function*(){var s;let e=(s=yield this.queryContract({query_domain_flags:{domain:t.split(".").pop()}}))==null?void 0:s.domain_flags;return e?e.web3_flags.is_public:!1})}getPreviousRecords(t,e){return g(this,null,function*(){let s={domain_record:{domain:`${t}.${e}`}},n=yield this.queryContract(s);return n.record!==null?n.record.records[0].agent_address.records:[]})}getRegistrationTx(t,e,s,n,i){return g(this,null,function*(){let o=i?ut:dt,a={messages:[]};if(yield this.isNameAvailable(t,n)){let c=(yield this.queryContract({contract_state:{}})).price_per_second,d=BigInt(c.amount)*BigInt(86400),p=c.denom;a.messages.push({typeUrl:"/cosmwasm.wasm.v1.MsgExecuteContract",value:{sender:e,contract:o,msg:{register:{domain:`${t}.${n}`}},funds:[{amount:d.toString(),denom:p}]}})}else if(!(yield this.isOwner(t,n,e)))return null;return a.messages.push({typeUrl:"/cosmwasm.wasm.v1.MsgExecuteContract",value:{sender:e,contract:o,msg:{update_record:{domain:`${t}.${n}`,agent_records:s}}}}),a})}register(t,e,s,n,i,o=!0){return g(this,null,function*(){l("Registering name...",y);let a=Ne(s);if(!a)throw new Error("Invalid record configuration");let[c]=yield e.getAccounts();if(!c)throw new Error("No account found in wallet");let d=(yield t.getChainId())==="dorado-1",p=yield Mt(d);for(let x of a)if(!p||!(yield p.isRegistered(x.address))){l(`Address ${x.address} needs to be registered in almanac contract to be registered in a domain.`,y);return}if(!(yield this.isDomainPublic(i))){l(`Domain ${i} is not public, please select a public domain`,y);return}let u=a;if(!o){let x=yield this.getPreviousRecords(n,i),R=new Map;[...x,...a].forEach(v=>{R.set(`${v.address}_${v.weight}`,v)}),u=Array.from(R.values())}let m=yield this.getRegistrationTx(n,c.address,u,i,d);if(!m){l(`Please select another name, ${n} is owned by another address`,y);return}let _=yield(yield ne.connectWithSigner(d?z:X,e)).signAndBroadcast(c.address,m.messages,"auto");yield nt(_.transactionHash,this.client),l("Registering name...complete",y)})}unregister(t,e,s,n=!0){return g(this,null,function*(){if(l("Unregistering name...",y),yield this.isNameAvailable(t,e)){l("Nothing to unregister... (name is not registered)",y);return}let i=yield ne.connectWithSigner(n?z:X,s),[o]=yield s.getAccounts();if(!o)throw new Error("No account found in wallet");let a={remove_domain:{domain:`${t}.${e}`}},c=yield i.execute(o.address,this.address,a,"auto");yield nt(c.transactionHash,this.client),l("Unregistering name...complete",y)})}},bt=null,St=null;function ie(r=!0){return g(this,null,function*(){if(r){if(!St){let t=yield rt(!0);St=new at(t,ut)}return St}if(!bt){let t=yield rt(!1);bt=new at(t,dt)}return bt})}var C=class C{constructor(t){this.faucetUrl=t}getWealth(t){return g(this,null,function*(){let e=yield this.createFaucetClaim(t);if(!e)throw new Error("Unable to create faucet claim");let s=C.MAX_RETRY_ATTEMPTS;for(;s>0;){let n=yield this.checkFaucetClaim(e);if(!n)throw new Error("Failed to check faucet claim status");if(n.status==="complete")break;if(n.status==="failed")throw new Error(`Failed to get wealth for ${t}`);yield new Promise(i=>setTimeout(i,C.POLL_INTERVAL_MS)),s--}if(s===0)throw new Error("Faucet claim check timed out");yield new Promise(n=>setTimeout(n,C.FINAL_WAIT_INTERVAL_MS))})}createFaucetClaim(t){return g(this,null,function*(){try{let e=yield fetch(`${this.faucetUrl}/api/v3/claims`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({address:t})});return e.ok?(yield e.json()).uuid:null}catch(e){return null}})}checkFaucetClaim(t){return g(this,null,function*(){var e;try{let s=yield fetch(`${this.faucetUrl}/api/v3/claims/${t}`);if(!s.ok)return null;let n=yield s.json();return{txDigest:((e=n.claim.txStatus)==null?void 0:e.hash)||null,status:n.claim.status}}catch(s){return null}})}};C.MAX_RETRY_ATTEMPTS=30,C.POLL_INTERVAL_MS=2e3,C.FINAL_WAIT_INTERVAL_MS=5e3;var xt=C;var ae=P("WARN","resolver");function Tt(r,t=void 0,e=1){return t?t.map(i=>Math.pow(Math.random(),1/i)).map((i,o)=>({value:i,index:o})).sort((i,o)=>o.value-i.value).slice(0,e).map(i=>i.index).map(i=>r[i]):[...r].sort(()=>Math.random()-.5).slice(0,e)}function De(r){return F(r)||r.length===Gt&&r.startsWith(Wt)}function Le(r){return[jt,G,""].includes(r)}function k(r){let t="",e="",s="";return r.includes("://")&&([t,r]=r.split("://",2)),r.includes("/")&&([e,r]=r.split("/",2)),De(r)?s=r:e=r,[t,e,s]}function Oe(r,t,e){return g(this,null,function*(){let s=yield Mt(e);if(!s)throw l(`Failed to get Almanac contract for ${e?"testnet":"mainnet"}`),new Error(`Failed to get Almanac contract for ${e?"testnet":"mainnet"}`);let n={query_record:{agent_address:r,record_type:t}};return yield s.queryContract(n)})}function ke(r,t){return g(this,null,function*(){var i,o;let e={domain_record:{domain:r}},n=yield(yield ie(t)).queryContract(e);if(!n)throw l(`Failed to get NameService contract for ${t?"testnet":"mainnet"}`),new Error(`Failed to get NameService contract for ${t?"testnet":"mainnet"}`);if(n.record!==null){let a=((o=(i=n.record.records[0])==null?void 0:i.agent_address)==null?void 0:o.records)||[];if(a.length>0){let c=a.map(u=>u.address),d=a.map(u=>u.weight),p=Tt(c,d);return p.length>0?p[0]:null}}return null})}var I=class{},Pt=class extends I{constructor(t){super(),this._maxEndpoints=t||L}resolve(t){return g(this,null,function*(){var o;let[e,,s]=k(t),i=yield Oe(s,"service",e!==G);if(i){let c=((o=(i.record||{}).service)==null?void 0:o.endpoints)||[];if(c.length>0){let d=c.map(u=>u.url),p=c.map(u=>u.weight);return[s,Tt(d,p,Math.min(this._maxEndpoints,d.length))]}}return[null,[]]})}},ct=class extends I{constructor(t,e){super(),this._maxEndpoints=t||L,this._almanacApiUrl=e||T,this._almanacContractResolver=new Pt(this._maxEndpoints)}_apiResolve(t){return g(this,null,function*(){try{let[,,e]=k(t),s=yield fetch(`${this._almanacApiUrl}/agents/${e}`);if(s.status!==200)return s.status!==404&&l(`Failed to resolve agent ${e} from ${this._almanacApiUrl}, resolving via Almanac contract...`,ae),[null,[]];let n=yield s.json(),i=n.expiry;if(!i)return[null,[]];let o=new Date(i),a=new Date,c=n.endpoints||[];if(c.length>0&&o>a){let d=c.map(u=>u.url),p=c.map(u=>u.weight);return[e,Tt(d,p,Math.min(this._maxEndpoints,d.length))]}}catch(e){l(`Error in AlmanacApiResolver when resolving ${t}: ${e}`,ae)}return[null,[]]})}resolve(t){return g(this,null,function*(){let[e,s]=yield this._apiResolve(t);return e!==null?[e,s]:yield this._almanacContractResolver.resolve(t)})}},Ct=class extends I{constructor(t){super(),this._maxEndpoints=t||L,this._almanacApiResolver=new ct(this._maxEndpoints)}resolve(t){return g(this,null,function*(){let[e,s]=k(t),i=yield ke(s,e!==G);return i!==null?yield this._almanacApiResolver.resolve(i):[null,[]]})}},gt=class extends I{constructor(t,e){super(),this._maxEndpoints=t||L,this._almanacApiResolver=new ct(this._maxEndpoints,e),this._nameServiceResolver=new Ct(this._maxEndpoints)}resolve(t){return g(this,null,function*(){let[e,,s]=k(t);return Le(e)?yield(s?this._almanacApiResolver:this._nameServiceResolver).resolve(t):[null,[]]})}},oe=class extends I{constructor(t,e){super(),this._rules=t,this._maxEndpoints=e||L}resolve(t){return g(this,null,function*(){let e=this._rules[t];return typeof e=="string"?e=[e]:e||(e=[]),e.length>this._maxEndpoints&&(e=e.slice(0,this._maxEndpoints)),[t,e]})}};var Fe=P("DEBUG","dispenser");function Ue(r,t,e=!1){return g(this,null,function*(){let s={"content-type":"application/json"};e&&(s["x-uagents-connection"]="sync");let n=[];for(let i of t)try{let o=yield fetch(i,{method:"POST",headers:s,body:JSON.stringify(r)});if(o.ok){if(e){let a=S.modelValidate(yield o.json());if(a.signature){let c=!1;try{a.verify(),c=!0}catch(d){n.push(`Received response envelope that failed verification: ${d}`)}if(!c)continue}return yield qe(a)}return{status:"delivered",detail:"Message successfully delivered via HTTP",destination:r.target,endpoint:i,session:r.session}}n.push(yield o.text())}catch(o){n.push(`Failed to send message: ${o}`)}return l(`Failed to deliver message to ${r.target} @ ${t}: ${n.join(", ")}`,Fe),{status:"failed",detail:"Message delivery failed",destination:r.target,endpoint:"",session:r.session}})}function qe(r){return g(this,null,function*(){return O.sinks.size===0?r:(yield O.dispatchMsg(r.sender,r.target,r.schemaDigest,r.decodePayload(),r.session),{status:"delivered",detail:"Sync message successfully delivered via HTTP",destination:r.target,endpoint:"",session:r.session})})}function Ve(c,d,p,u,m,B){return g(this,arguments,function*(r,t,e,s,n,i,o=b,a=!1){let _;if(typeof n=="string"&&F(n)&&(_=n),n||(n=A.generate()),n instanceof A&&(_=n.getAddress),!_)throw new Error("Invalid sender address");i||(i=new gt);let[x,R]=yield i.resolve(r);if(!R||!x)return{status:"failed",detail:"Failed to resolve destination address",destination:r,endpoint:"",session:void 0};let v=new S({version:1,sender:_,target:x,session:$e(),schemaDigest:t,expires:Math.floor(Date.now()/1e3)+o});v.encodePayload(e),!F(_)&&n instanceof A&&v.sign(n);let E=yield Ue(v,R,a);if(E instanceof S){if(!v.signature)return E;let W=E.decodePayload();return s?s.modelValidateJson(W):W}return E})}function He(a,c,d,p,u){return g(this,arguments,function*(r,t,e,s,n,i=b,o=!1){return yield Ve(r,f.buildSchemaDigest(t),t.dumpJson(t),e,s,n,i,o)})}function dr(o,a,c,d,p){return g(this,arguments,function*(r,t,e,s,n,i=b){return yield He(r,t,e,s,n,i,!0)})}function ur(r,t,e,s=""){return We(r.dumpJson(r),f.buildSchemaDigest(r),t,e,s)}function We(r,t,e,s,n=""){let i=new S({version:1,sender:e,target:n,session:s,schemaDigest:t});return i.encodePayload(r),JSON.stringify(i,null,0)}import{v4 as je}from"uuid";import{z as It}from"zod";var Ge=It.object({error:It.string(),details:It.string().optional()}).openapi({title:"ErrorMessage"}),Je=f.buildSchemaDigest(Ge);function Ke(r){let t="",e="",s="";return r.includes("://")&&([t,r]=r.split("://",2)),r.includes("/")&&([e,r]=r.split("/",2)),ze(r)?s=r:e=r,[t,e,s]}function ze(r){return!0}var Nt=class{},Dt=class extends Nt{constructor(e,s,n,i,o,a,c,d,p){super();this._outboundMessages=new Map;this._agent=e,this._storage=s,this._ledger=n,this._resolver=i,this._dispenser=o,this._logger=p,this._session=a||je(),this._intervalMessages=c,this._walletMessagingClient=d}get agent(){return this._agent}get storage(){return this._storage}get ledger(){return this._ledger}get logger(){return this._logger||(this._logger={logLevel:"INFO",name:"internal"}),this._logger}get session(){return this._session}get outboundMessages(){return this._outboundMessages}get address(){return this.agent.address}getAgentsByProtocol(i){return g(this,arguments,function*(e,s=ft,n){var a;if(!e.startsWith("proto:"))return l(`Invalid protocol digest: ${e}`,n),[];let o=((a=this._resolver._almanacApiResolver)==null?void 0:a._almanacApiUrl)||T;try{let c=yield fetch(`${o}/search`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e.slice(6)}),signal:AbortSignal.timeout(b*1e3)});if(c.ok)return(yield c.json()).filter(u=>u.status==="active").map(u=>u.address).slice(0,s)}catch(c){l(`Failed to query Almanac API: ${c}`,n)}return[]})}broadcast(o,a){return g(this,arguments,function*(e,s,n=ft,i=b){let c=yield this.getAgentsByProtocol(e,n,this.logger);if(!c.length)return l(`No active agents found for: ${e}`,this.logger),[];let p=c.filter(m=>m!==this.agent.address).map(m=>this.send(m,s,!1,i)),u=yield Promise.all(p);return l(`Sent ${u.length} messages`,this.logger),u})}_isValidIntervalMessage(e){return this._intervalMessages?this._intervalMessages.has(e):!0}send(o,a){return g(this,arguments,function*(e,s,n=!1,i=b){let c=f.buildSchemaDigest(s),d=JSON.stringify(s.dump({}));return this._isValidIntervalMessage(c)?this.sendRaw(e,c,d,n,i):(l(`Invalid interval message: ${s}`,this.logger),{status:"failed",detail:"Invalid interval message",destination:e,endpoint:"",session:this._session})})}sendRaw(d,p,u){return g(this,arguments,function*(e,s,n,i=!1,o=b,a,c){let[,,m]=Ke(e);if(m){if(O.contains(m))return yield O.dispatchMsg(this.agent.address,m,s,n,this._session),{status:"delivered",detail:"Message dispatched locally",destination:m,endpoint:"",session:this._session};if(c!=null&&c.has(m)){let E=c.get(m);return c.delete(m),yield E,{status:"delivered",detail:"Sync message resolved",destination:m,endpoint:"",session:this._session}}this._outboundMessages.set(m,[n,s])}let[B,_]=yield this._resolver.resolve(e);if(!_.length||!B)return l("Unable to resolve destination endpoint",this.logger),{status:"failed",detail:"Unable to resolve destination endpoint",destination:e,endpoint:"",session:this._session};let x=Math.floor(Date.now()/1e3)+o,R=new S({version:1,sender:this.agent.address,target:B,session:this._session,schemaDigest:s,protocolDigest:a,expires:x});R.encodePayload(n),R.sign({signDigest:this.agent.signDigest});let v=new Promise((E,W)=>{setTimeout(()=>W(new Error("Timeout")),o*1e3)});this._queueEnvelope(R,_,v,i);try{let E=yield v;return E instanceof S?{status:"delivered",detail:"Sync response received",destination:e,endpoint:_[0]||"",session:this._session}:E}catch(E){return l("Timeout waiting for dispense response",this.logger),{status:"failed",detail:"Timeout waiting for response",destination:e,endpoint:"",session:this._session}}})}_queueEnvelope(e,s,n,i=!1){this._dispenser.addEnvelope(e,s,n,i)}sendWalletMessage(e,s,n=1){return g(this,null,function*(){this._walletMessagingClient?yield this._walletMessagingClient.send(e,s,n):l("Cannot send wallet message: no client available",this.logger)})}},ce=class extends Dt{constructor(t,e,s,n,i,o,a,c,d,p,u,m,B){super(e,s,n,i,o,p,u,m,B),this._queries=a||new Map,this._replies=c,this._messageReceived=t,this._protocol=d||["",null]}_isValidReply(t){if(t===Je)return!0;if(!this._messageReceived)throw new Error("No message received");if(!this._replies)return!0;let e=this._messageReceived,s=this._replies.get(e.schema_digest);return s?s.has(t):!1}send(i,o){return g(this,arguments,function*(t,e,s=!1,n=b){let a=f.buildSchemaDigest(e);return this._isValidReply(a)?this.sendRaw(t,a,JSON.stringify(e.dump({})),s,n,this._protocol[0],this._queries):(l(`Outgoing message '${e.constructor.name}' is not a valid reply to received message: ${this._messageReceived.schema_digest}`,this.logger),{status:"failed",detail:"Invalid reply",destination:t,endpoint:"",session:this._session})})}};var Pr="tmp";import{z as Xe}from"zod";import Ze from"crypto";import{extendZodWithOpenApi as Qe}from"zod-openapi";Qe(Xe);var Ye="3.0.2",ge=class r{constructor(t,e){this._intervalHandlers=[];this._intervalMessages=new Set;this._signedMessageHandlers={};this._unsignedMessageHandlers={};this._models={};this._replies={};this._name=t||"",this._version=e||"0.1.0",this._canonicalName=`${this._name}:${this._version}`,this._digest="",this.spec={title:this._name,version:this._version,openapi_version:Ye}}get intervals(){return this._intervalHandlers}get models(){return this._models}get replies(){return this._replies}get intervalMessages(){return this._intervalMessages}get signedMessageHandlers(){return this._signedMessageHandlers}get unsignedMessageHandlers(){return this._unsignedMessageHandlers}get name(){return this._name}get version(){return this._version}get canonicalName(){return this._canonicalName}get digest(){return this.manifest().metadata.digest}onInterval(t,e){return s=>(this._addIntervalHandler(t,s,e),s)}_addIntervalHandler(t,e,s){this._intervalHandlers.push([e,t]),s&&(s instanceof Set?s:new Set([s])).forEach(i=>{let o=f.buildSchemaDigest(i);this._intervalMessages.add(o)})}onQuery(t,e){return this.onMessage(t,e,!0)}onMessage(t,e,s=!1){return n=>(this._addMessageHandler(t,n,e,s),n)}_addMessageHandler(t,e,s,n=!1){let i=f.buildSchemaDigest(t);if(this._models[i]=t,n?this._unsignedMessageHandlers[i]=e:this._signedMessageHandlers[i]=e,s){let o=s instanceof Set?s:new Set([s]);this._replies[i]={},o.forEach(a=>{let c=f.buildSchemaDigest(a);this._models[c]=a})}}manifest(){let t={name:this._name,version:this._version},e={version:"1.0",metadata:{},models:[],interactions:[]},s={};Object.entries(this._models).forEach(([a,c])=>{s[a]||(s[a]=c)}),Object.values(this._replies).forEach(a=>{Object.entries(a).forEach(([c,d])=>{s[c]||(s[c]=d)})}),Object.entries(s).forEach(([a,c])=>{e.models.push({digest:a,schema:c.dump({})})}),Object.entries(this._replies).forEach(([a,c])=>{e.interactions.push({type:this._unsignedMessageHandlers[a]?"query":"normal",request:a,responses:Object.keys(c)})});let n=N(M({},e),{metadata:{}}),i=JSON.stringify(n,null,0);return t.digest=r.computeDigest(e),N(M({},e),{metadata:t})}static computeDigest(t){let e=N(M({},t),{metadata:{}}),s=JSON.stringify(e,null,0);return`proto:${Ze.createHash("sha256").update(s).digest("hex")}`}};var kr="tmp";import*as ue from"crypto";var h=P("INFO","AgentRegistration");function ts(r){return Math.min(Ht(2,r+6),131072)/1e3}function es(r){let t=new Set;return JSON.stringify(r,(e,s)=>(t.add(e),s)),JSON.stringify(r,Array.from(t).sort())}var Lt=class{constructor(t){this.agent_identifier=t}sign(t){this.timestamp=Math.floor(Date.now()/1e3);let e=this._buildDigest();this.signature=t.signDigest(e)}verify(){if(!this.signature)throw new Error("signature is missing");A.verifyDigest(this.agent_identifier,this._buildDigest(),this.signature)}_buildDigest(){let t=es(N(M({},this),{signature:void 0})),e=ue.createHash("sha256");return e.update(t,"utf-8"),e.digest()}},lt=class extends Lt{constructor(t,e,s,n=null){super(t),this.protocols=e,this.endpoints=s,this.metadata=n}},Ot=class{constructor(t){this.attestations=t}};function pe(s,n){return g(this,arguments,function*(r,t,e=J){for(let i=0;i<e;i++)try{let o=yield fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(o.ok)return!0;l(`API responded with ${o.status}: ${yield o.text()}`,h)}catch(o){if(i===e-1)return l(`Failed after ${e} retries: ${o}`,h),!1;yield new Promise(a=>setTimeout(a,ts(i)))}return!1})}var V=class{},H=class{},kt=class extends V{constructor(t,e=T){super(),this.identity=t,this.almanacApi=e,this.maxRetries=J}register(t,e,s,n=null){return g(this,null,function*(){let i=new lt(t,e,s,n);if(i.sign(this.identity),yield pe(`${this.almanacApi}/agents`,i,this.maxRetries))l("Registration on Almanac API successful",h);else throw new Error("Registration on Almanac API failed")})}},Bt=class extends V{constructor(t,e,s,n,i){super(),this.identity=t,this.ledger=e,this.wallet=s,this.almanacContract=n,this.testnet=i}register(t,e,s,n=null){return g(this,null,function*(){let i=k(t)[2],o=yield this.almanacContract.isRegistered(i),a=yield this.almanacContract.getExpiry(i),c=yield this.almanacContract.getEndpoints(i),d=yield this.almanacContract.getProtocols(i);if(!o||a<zt||JSON.stringify(s)!==JSON.stringify(c)||JSON.stringify(e)!==JSON.stringify(d)){if((yield this.ledger.queryBankBalance(this.wallet.address()))<parseInt(D))if(this.testnet)yield Rt(this.wallet.address());else throw new q("Not enough funds for registration.");l("Registering on Almanac contract...",h);let u=Math.floor(Date.now()/1e3)-K,m=this.identity.signRegistration(this.almanacContract.getAddress(),u,this.wallet.address());yield this.almanacContract.register(this.ledger,this.wallet,i,e,s,m,u),l("Registration on Almanac contract complete",h)}else l("Almanac contract registration is up to date",h)})}},$t=class extends H{constructor(t=T){super(),this.almanacApi=t,this.attestations=[],this.maxRetries=J}addAgent(t,e){let s=new lt(`${t.prefix}://${t.agent_address}`,t.protocols,t.endpoints,t.metadata);s.sign(e),this.attestations.push(s)}register(){return g(this,null,function*(){if(this.attestations.length===0){l("No agents to register in batch.",h);return}let t=new Ot(this.attestations);if(yield pe(`${this.almanacApi}/agents/batch`,t,this.maxRetries))l("Batch registration on Almanac API successful",h);else throw new Error("Batch registration on Almanac API failed")})}},Ft=class extends H{constructor(t,e,s,n){super(),this.ledger=t,this.wallet=e,this.almanacContract=s,this.testnet=n,this.records=[],this.identities={}}addAgent(t,e){let s={agentAddress:t.agent_address,protocols:t.protocols,endpoints:t.endpoints,contractAddress:this.almanacContract.getAddress(),senderAddress:this.wallet.address()};this.records.push(s),this.identities[t.agent_address]=e}getBalance(){return g(this,null,function*(){return yield this.ledger.queryBankBalance(this.wallet.address())})}register(){return g(this,null,function*(){if(this.records.length===0){l("No agents to register in batch.",h);return}if((yield this.getBalance())<parseInt(D)*this.records.length)if(l(`Insufficient funds to register ${this.records.length} agents.`,h),this.testnet)yield Rt(this.wallet.address()),l("Testnet funds added.",h);else throw new q("Not enough funds for batch registration.");for(let e of this.records){let s=this.identities[e.agentAddress];if(!s)throw new Error(`Identity for agentAddress ${e.agentAddress} is not defined.`);let n=Math.floor(Date.now()/1e3)-K;e.signature=s.signRegistration(e.contractAddress,n,e.senderAddress)}yield this.almanacContract.registerBatch(this.ledger,this.wallet,this.records),l("Batch registration on Almanac contract complete.",h)})}},le=class extends V{constructor(t,e,s,n,i=!0){super(),this.apiPolicy=new kt(t),e&&s&&n&&(this.ledgerPolicy=new Bt(t,e,s,n,i))}register(t,e,s,n=null){return g(this,null,function*(){try{yield this.apiPolicy.register(t,e,s,n)}catch(i){l(`API registration failed: ${i}`,h)}if(this.ledgerPolicy)try{yield this.ledgerPolicy.register(t,e,s,n)}catch(i){l(`Ledger registration failed: ${i}`,h)}})}},de=class extends H{constructor(t,e,s,n=!0){super(),this.apiPolicy=new $t,t&&e&&s&&(this.ledgerPolicy=new Ft(t,e,s,n))}addAgent(t,e){this.apiPolicy.addAgent(t,e),this.ledgerPolicy&&this.ledgerPolicy.addAgent(t,e)}register(){return g(this,null,function*(){try{yield this.apiPolicy.register()}catch(t){l(`API batch registration failed: ${t}`,h)}if(this.ledgerPolicy)try{yield this.ledgerPolicy.register()}catch(t){l(`Ledger batch registration failed: ${t}`,h)}})}};import Ut from"fs";import ss from"path";import{ec as rs}from"elliptic";var Qr=new rs("secp256k1"),me=class{constructor(t,e=null){this._data={};this._name=t||"my";let s=e||process.cwd();this._path=ss.join(s,`${this._name}_data.json`),Ut.existsSync(this._path)&&this._load()}get(t){return this._data[t]||null}has(t){return t in this._data}set(t,e){this._data[t]=e,this._save()}remove(t){t in this._data&&(delete this._data[t],this._save())}clear(){this._data={},this._save()}_load(){let t=Ut.readFileSync(this._path,"utf-8");this._data=JSON.parse(t)}_save(){Ut.writeFileSync(this._path,JSON.stringify(this._data,null,4),"utf-8")}};var tn="tmp";export{Xt as AGENTVERSE_URL,Gt as AGENT_ADDRESS_LENGTH,Wt as AGENT_PREFIX,J as ALMANAC_API_MAX_RETRIES,ds as ALMANAC_API_TIMEOUT_SECONDS,T as ALMANAC_API_URL,ht as ALMANAC_CONTRACT_VERSION,K as ALMANAC_REGISTRATION_WAIT,os as ASGI,mt as AVERAGE_BLOCK_INTERVAL,is as Agent,kt as AlmanacApiRegistrationPolicy,ct as AlmanacApiResolver,Pt as AlmanacContractResolver,$t as BatchAlmanacApiRegistrationPolicy,Ft as BatchLedgerRegistrationPolicy,Nt as Context,b as DEFAULT_ENVELOPE_TIMEOUT_SECONDS,L as DEFAULT_MAX_ENDPOINTS,ft as DEFAULT_SEARCH_LIMIT,de as DefaultBatchRegistrationPolicy,le as DefaultRegistrationPolicy,S as Envelope,ee as EnvelopeHistory,te as EnvelopeHistoryEntry,Ge as ErrorMessage,ce as ExternalContext,gt as GlobalResolver,A as Identity,Dt as InternalContext,me as KeyValueStore,gs as LEDGER_PREFIX,Bt as LedgerBasedRegistrationPolicy,us as MAILBOX_POLL_INTERVAL_SECONDS,Jt as MAINNET_CONTRACT_ALMANAC,dt as MAINNET_CONTRACT_NAME_SERVICE,G as MAINNET_PREFIX,X as MAINNET_RPC,f as Model,Ct as NameServiceResolver,ge as Protocol,pt as REGISTRATION_DENOM,D as REGISTRATION_FEE,ls as REGISTRATION_RETRY_INTERVAL_SECONDS,zt as REGISTRATION_UPDATE_INTERVAL_SECONDS,ms as RESPONSE_TIME_HINT_SECONDS,I as Resolver,oe as RulesBasedResolver,Kt as TESTNET_CONTRACT_ALMANAC,ut as TESTNET_CONTRACT_NAME_SERVICE,Zt as TESTNET_FAUCET,jt as TESTNET_PREFIX,z as TESTNET_RPC,j as USER_PREFIX,ps as WALLET_MESSAGING_POLL_INTERVAL_SECONDS,tn as Wallet,xe as deriveKeyFromSeed,O as dispatcher,ur as encloseResponse,We as encloseResponseRaw,Z as encodeLengthPrefixed,bs as generateUserAddress,F as isUserAddress,Pr as mailbox,fs as parseAgentverseConfig,hs as parseEndpointConfig,k as parseIdentifier,kr as query,He as sendMessage,dr as sendSyncMessage};
